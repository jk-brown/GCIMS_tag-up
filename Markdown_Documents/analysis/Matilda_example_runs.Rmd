---
title: "GCIMS Tag-up Analysis"
author: "Joe Brown"
date: "2024-01-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r, message=FALSE, results='hide'}
# load libraries
library(MASS)
library(ggplot2)
library(see)
# force load the dev branch of Matilda to pick-up error corrections
# if on windows and R won't install first run this in console --> options(download.file.method = "wininet") 
remotes::install_github("jgcri/matilda@dev", force = T)
library(matilda)
library(parallel)
library(dplyr)
```

# Read in SSP scenario ini files

Read in as a list to making looping the analysis easier.

```{r, results='hide'}

ini_list <- list(
ssp126 = system.file("input/hector_ssp126.ini", package = "hector"), 
ssp245 = system.file("input/hector_ssp245.ini", package = "hector"), 
ssp370 = system.file("input/hector_ssp370.ini", package = "hector"),
ssp585 = system.file("input/hector_ssp585.ini", package = "hector") 
)

```

# Initiate cores

For each of the SSP ini files, initiate a Hector core.

```{r, results='hide'}

core_list <- lapply(ini_list, newcore)

```

# Generate 10000 parameter sets 

```{r, results='hide'}

set.seed(123)

n = 10

init_params <- generate_params(core = core_list[[1]], draws = n)

```

# Use multiple threads to run local parallel computing

```{r}
cluster <- makeCluster(detectCores() - 1)

clusterExport(cluster, c("iterate_model", "init_params", "ini_list", "newcore"))

start <- proc.time()

init_result <- parLapply(cluster, ini_list, function(scenario) {
  
  # initialize the core
  core = newcore(scenario)
  
  # call iterate_model and run Hector for each param set looping across scenarios
  iterate_model(
    core = core, 
    params = init_params,
    save_years = 1800:2100,
    save_vars = c("CO2_concentration", "gmst")
  )
})

stopCluster(cluster)

proc.time() - start
```
# Fix the unnamed scenario column

Made a mistake by not adding names of the scenarios when initializing the cores.

Add scenario names to the scenarios column for each df in init_results:
```{r}
# Start lapply by iterating through the names of the dfs in init_result
init_result <- lapply(names(init_result), function(name) {
  
  # Access the data frame with the current name from the list 
  init_result[[name]] <- init_result[[name]] %>% 
  # use dplyr mutate to replace values in "scenario" column with the name of the data frame
    mutate(scenario = name)
  
  return(init_result[[name]])
})
```


